library(OutFLANK)
library(vcfR)
library(dartR)


###############
###OutFLANK####
###############
rm(list=ls())
geno <- read.table("./rda_input/gzsd.rda.geno",header=FALSE)
loc <- read.table("./chrom_pos_rowID/gzsd.chrom.pos.rowID.list",header=FALSE)
popmap <- read.table("pop_info/popmap_filtered_gzsd.txt",header=TRUE)

colnames(loc) <- c("id","chrom","pos")
colnames(geno)=loc$id
rownames(geno)=popmap$sample
dim(geno)
head(geno)[,1:6]
sum(is.na(geno))
geno[is.na(geno)]=9 #replace NA with 9 as missing data
sum(geno==9)
#calculate Fst based on pops
OF_SNPs <- MakeDiploidFSTMat(geno, locusNames=loc$id, popNames=popmap$pop) 


#trim loci in the upper and lower 5% of the emprical distribution, He or Hmin
OF_out <- OutFLANK(FstDataFrame=OF_SNPs, 
                   LeftTrimFraction=0.05, RightTrimFraction=0.05, 
                   Hmin=0.1, NumberOfSamples=6, qthreshold=0.05) #NumberOfSamples is # of pops;

#plot it with chisq distribution
pdf("./outflank_output/gzsd.ofk.fst.dist.pdf")
par(mfrow=c(2,1))
OutFLANKResultsPlotter(OF_out, withOutliers=T, NoCorr=T, Hmin=0.1, binwidth=0.005) 
OutFLANKResultsPlotter(OF_out, withOutliers=T, NoCorr=T, Hmin=0.1, binwidth=0.005, Zoom=TRUE) 
dev.off()

outliers <- OF_out$results$LocusName[OF_out$results$OutlierFlag=="TRUE"]
length(outliers)

write.table(outliers, "./outflank_output/gzsd.outflank.outliers.txt", quote=F, row.names=F)
